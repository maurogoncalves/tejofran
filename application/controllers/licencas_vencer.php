<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Licencas_Vencer extends CI_Controller {
 
 function __construct(){	parent::__construct();	$this->load->model('log_model','',TRUE);	$this->load->model('licenca_model','',TRUE);	$this->load->model('lojas_licencas_model','',TRUE);			
 $this->load->model('licenca_vencida_model','',TRUE);			$this->load->model('licenca_vencer_model','',TRUE);			
 $this->load->model('cnd_imobiliaria_model','',TRUE);		
 $this->load->model('cnd_imobiliaria_model','',TRUE);    
 $this->load->model('emitente_imovel_model','',TRUE);    
 $this->load->model('tipo_emitente_model','',TRUE);    $this->load->model('situacao_imovel_model','',TRUE);    
 $this->load->model('informacoes_inclusas_iptu_model','',TRUE);    $this->load->model('user','',TRUE);    
 $this->load->model('contratante','',TRUE);    $this->load->model('emitente_model','',TRUE);    
 $this->load->model('imovel_model','',TRUE);    $this->load->model('iptu_model','',TRUE);    
 $this->load->library('Cep');    $this->load->library('session');       $this->load->library('form_validation');    
 $this->load->helper('url');	
 
 }
  function cadastrar(){	$session_data = $this->session->userdata('logged_in');    $data['email'] = $session_data['email'];	$data['empresa'] = $session_data['empresa'];	$data['perfil'] = $session_data['perfil'];	$idContratante = $_SESSION['cliente'] ;	$data['emitentes'] = $this->licenca_model->listarEmitentes($idContratante);	$data['tipos_licencas'] = $this->licenca_model->listarTipoLicenca();	$this->load->view('header_view',$data);    $this->load->view('cadastrar_licenca_view', $data);	$this->load->view('footer_view');  }
 function index(){
   if($this->session->userdata('logged_in')){
     $session_data = $this->session->userdata('logged_in');	 
     $data['email'] = $session_data['email'];
	 $data['empresa'] = $session_data['empresa'];
	 $data['perfil'] = $session_data['perfil'];	 
     $this->load->view('home_view', $data);
   }else{
     //If no session, redirect to login page
     redirect('login', 'refresh');
   }
 } function atualizar_licenca(){    if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$idUsuario = $session_data['id'];	$id_emitente = $this->input->post('id_emitente');		$tipo_licenca = $this->input->post('tipo_licenca');	$cep = $this->input->post('cep');		$numero = $this->input->post('numero');		$logradouro = $this->input->post('logradouro');		$bairro = $this->input->post('bairro');		$cidade = $this->input->post('cidade');		$estado = $this->input->post('estado');		$data_vencto = $this->input->post('data_vencto');		$arrDataVencto = explode("/",$data_vencto);	$dataVencto = $arrDataVencto[2].'-'.$arrDataVencto[1].'-'.$arrDataVencto[0];	$observacoes = $this->input->post('observacoes');		$id = $this->input->post('id');				$dados = array(	'id_contratante' => $idContratante,	'id_emitente' => $id_emitente,	'tipo_licenca_taxa' => $tipo_licenca,	'data_vencimento' => $dataVencto,	'observacoes' => utf8_decode($observacoes),	'ativo' => 0,	'cep' => $cep,	'numero' => $numero,	'rua' => ($logradouro),	'bairro' => ($bairro),	'cidade' => ($cidade),	'estado' => $estado,	);		$dadosContratante = $this->licenca_model->listarContratante($idContratante);		$dadosEmitente = $this->licenca_model->listarLicencasByEmitente($idContratante,$id_emitente);	$dadosTipoLicenca = $this->licenca_model->listarTipoLicencaById($tipo_licenca);		$dadosAtuais = $this->licenca_model->listarLicencaById($id);		$dadosAlterados = '';	if($dadosAtuais[0]->id_emitente <> $id_emitente){		$dadosAlterados .= 'Emitente: '.$dadosEmitente[0]->razao_social;	}	if($dadosAtuais[0]->tipo_licenca_taxa <> $tipo_licenca){		$dadosAlterados .= ' - Tipo de Licenca: '.$dadosTipoLicenca[0]->descricao;	}	if($dadosAtuais[0]->data_vencimento <> $data_vencto){		$dadosAlterados .= ' - Data Vencimento: '.$data_vencto;	}	if($dadosAtuais[0]->observacoes <> $observacoes){		$dadosAlterados .= ' - Observacoes: '.$observacoes;	}	if($dadosAtuais[0]->cep <> $cep){		$dadosAlterados .= ' - CEP: '.$cep;		$dadosAlterados .= ' - Rua: '.$logradouro;		$dadosAlterados .= ' - Bairro: '.$bairro;		$dadosAlterados .= ' - Cidade: '.$cidade;		$dadosAlterados .= ' - Estado: '.$estado;	}		if($dadosAtuais[0]->numero <> $numero){		$dadosAlterados .= ' - Numero: '.$numero;	}			$dadosLog = array(	'id_contratante' => $idContratante,	'tabela' => 'licencas',	'id_usuario' => $idUsuario,	'id_operacao' => $id,	'tipo' => 2,	'texto' => $dadosAlterados,	'data' => date("Y-m-d"),	);	$this->log_model->log($dadosLog);	if($this->licenca_model->atualizar($dados,$id)) {		$data['mensagem'] = 'Cadastro Atualizado com Sucesso';	}else{			$data['mensagem'] = 'Algum Erro Aconteceu';	}						redirect('licencas/listar');					 } function contaVencidas(){  if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$total = $this->licenca_model->contaVencidas($idContratante);	return($total);	 }  
 function cadastrar_licenca(){    if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$id_emitente = $this->input->post('id_emitente');	
	$tipo_licenca = $this->input->post('tipo_licenca');	$cep = $this->input->post('cep');		$numero = $this->input->post('numero');		$logradouro = $this->input->post('logradouro');		$bairro = $this->input->post('bairro');		$cidade = $this->input->post('cidade');		$estado = $this->input->post('estado');		$data_vencto = $this->input->post('data_vencto');		$arrDataVencto = explode("/",$data_vencto);	$dataVencto = $arrDataVencto[2].'-'.$arrDataVencto[1].'-'.$arrDataVencto[0];	$observacoes = $this->input->post('observacoes');				$dados = array('id_contratante' => $idContratante,					'id_emitente' => $id_emitente,					'tipo_licenca_taxa' => $tipo_licenca,					'data_vencimento' => $dataVencto,					'observacoes' => $observacoes,					'ativo' => 0,					'cep' => $cep,					'numero' => $numero,					'rua' => $logradouro,					'bairro' => $bairro,					'cidade' => $cidade,					'estado' => $estado,				);				
	if($this->licenca_model->add($dados)) {		$this->db->cache_off();
		$data['mensagem'] = 'Cadastro Realizado com Sucesso';
	}else{	
		$data['mensagem'] = 'Algum Erro Aconteceu';
	}
		redirect('licencas/listar');
	
				
 }  
 function inativar(){	if(!$this->session->userdata('logged_in')){			redirect('login', 'refresh');	  }  	$id = $this->input->get('id');	$dados = array('ativo' => 1);	if($this->licenca_model->atualizar($dados,$id)) {//	print_r($this->db->last_query());exit;		$data['mensagem'] = 'Cadastro Atualizado com Sucesso';	}else{			$data['mensagem'] = 'Algum Erro Aconteceu';	}	redirect('licencas/listar');					 }  function ativar(){	if(!$this->session->userdata('logged_in')){			redirect('login', 'refresh');	  }  	$id = $this->input->get('id');	$dados = array('ativo' => 0);	if($this->licenca_model->atualizar($dados,$id)) {//	print_r($this->db->last_query());exit;		$data['mensagem'] = 'Cadastro Atualizado com Sucesso';	}else{			$data['mensagem'] = 'Algum Erro Aconteceu';	}		redirect('licencas/listar');				 }  
  function editar(){	    if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }
	$id = $this->input->get('id');
	$session_data = $this->session->userdata('logged_in');
	$idContratante = $_SESSION['cliente'] ;
	$data['dados'] = $this->licenca_model->listarLicencaById($id);		$data['perfil'] = $session_data['perfil'];		$data['emitentes'] = $this->licenca_model->listarEmitentes($idContratante);	$data['tipos_licencas'] = $this->licenca_model->listarTipoLicenca();
	$this->load->view('header_view',$data);
    $this->load->view('editar_licenca_view', $data);
	$this->load->view('footer_view');

 } function buscaLicencaByEmitente(){		$id = $this->input->get('id');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_vencer_model->listarLicencasByEmitente($idContratante,$id);	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno .="0";			}else{			foreach($result as $key => $licenca){ 			 		if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'-'.$dataVArr[1].'-'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->razao_social."</td>";		 $retorno .="<td>".$licenca->descricao."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->bairro."</td>";		 $retorno .="<td>".$licenca->cidade."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>";		 $retorno .="<a href='$base/loja/editar_loja_licenca?id_licenca=$licenca->id_licenca&id_loja=$licenca->id_loja' class='btn btn-primary btn-xs'><i class='fa fa-pencil'></i></a>";		 $retorno .="</td>";		 $retorno .="</tr>";						 		}		}	echo json_encode($retorno);	 } function buscaLicencaByCidade(){		$id = $this->input->get('id');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_vencer_model->listarLicencasByCidade($idContratante,$id);	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno .="0";			}else{			foreach($result as $key => $licenca){ 			 		if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'-'.$dataVArr[1].'-'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->razao_social."</td>";		 $retorno .="<td>".$licenca->descricao."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->bairro."</td>";		 $retorno .="<td>".$licenca->cidade."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>";		 $retorno .="<a href='$base/loja/editar_loja_licenca?id_licenca=$licenca->id_licenca&id_loja=$licenca->id_loja' class='btn btn-primary btn-xs'><i class='fa fa-pencil'></i></a>";		 $retorno .="</td>";		 $retorno .="</tr>";						 		}		}	echo json_encode($retorno);	 }  function export(){			$id = $this->input->post('id_emitente_export');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	if($id <> 0){		$result = $this->licenca_vencer_model->listarLicencasByEmitente($idContratante,$id);	}else{		$result = $this->licenca_vencer_model->listarLicencasTodos($idContratante);	}		//print_r($this->db->last_query());exit;	$file="licencas_por_emitente.xls";	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno="<table border=1>		<tr>		<td>N&atilde;o H&aacute; Dados Para Esse Filtro</td>				</tr>		";		$retorno .='</table>';			}else{		$retorno="<table border=1>			<tr>			<td>Id</td>			<td>Nome Fantasia</td>			<td>CPF/CNPJ</td>			<td>Descri&ccedil;&atilde;o</td>			<td>Data Vencimento</td>			<td>Rua</td>			<td>N&uacute;mero</td>			<td>Bairro</td>			<td>Cidade</td>			<td>Estado</td>			<td>Ativo</td>			<td>Alterado Por </td>			<td>Data Altera&ccedil;&atilde;o </td>			<td>Dados Alterados </td>			</tr>			";		foreach($result as $key => $licenca){ 			$dadosLog = $this->log_model->listarLog($licenca->id_licenca,'licencas');			$isArrayLog =  is_array($dadosLog) ? '1' : '0';					//print_r($dadosLog);exit;		if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'/'.$dataVArr[1].'/'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->id_licenca."</td>";		 $retorno .="<td>".utf8_decode($licenca->nome_fantasia)."</td>";		 $retorno .="<td>".$licenca->cpf_cnpj."</td>";		 $retorno .="<td>".utf8_decode($licenca->descricao)."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->endereco."</td>";		 $retorno .="<td>".$licenca->numero."</td>";		 $retorno .="<td>".utf8_decode($licenca->bairro)."</td>";		 $retorno .="<td>".utf8_decode($licenca->cidade)."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>".$status."</td>";		 if($isArrayLog <> 0){			 $dataFormatadaArr = explode('-',$dadosLog[0]->data);			 $dataFormatada = $dataFormatadaArr[2].'/'.$dataFormatadaArr[1].'/'.$dataFormatadaArr[0];			 $retorno .="<td>".$dadosLog[0]->email."</td>";			 $retorno .="<td>".$dataFormatada."</td>";			 $retorno .="<td>".utf8_decode($dadosLog[0]->texto)."</td>";		 }else{			$retorno .="<td></td>";			 $retorno .="<td></td>";			 $retorno .="<td></td>";		 }		 $retorno .="</tr>";						 		}		$retorno .='</table>';		}		header("Content-type: application/vnd.ms-excel");	header("Content-Disposition: attachment; filename=$file");	echo $retorno;		//echo json_encode($retorno);	 }  function export_mun(){			$id = $this->input->post('id_mun_export');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_model->listarLicencasByCidade($idContratante,$id);	//print_r($this->db->last_query());exit;	$file="licencas_por_cidade.xls";	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno="<table border=1>		<tr>		<td>N&atilde;o H&aacute; Dados Para Esse Filtro</td>				</tr>		";		$retorno .='</table>';			}else{		$retorno="<table border=1>			<tr>			<td>Id</td>			<td>Nome Fantasia</td>			<td>CPF/CNPJ</td>			<td>Descri&ccedil;&atilde;o</td>			<td>Data Vencimento</td>			<td>Rua</td>			<td>N&uacute;mero</td>			<td>Bairro</td>			<td>Cidade</td>			<td>Estado</td>			<td>Ativo</td>			<td>Alterado Por </td>			<td>Data Altera&ccedil;&atilde;o </td>			<td>Dados Alterados </td>			</tr>			";		foreach($result as $key => $licenca){ 		$dadosLog = $this->licenca_model->listarLog($licenca->id_licenca);			$isArrayLog =  is_array($dadosLog) ? '1' : '0';				if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'/'.$dataVArr[1].'/'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->id_licenca."</td>";		 $retorno .="<td>".utf8_decode($licenca->nome_fantasia)."</td>";		 $retorno .="<td>".$licenca->cpf_cnpj."</td>";		 $retorno .="<td>".utf8_decode($licenca->descricao)."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->endereco."</td>";		 $retorno .="<td>".$licenca->numero."</td>";		 $retorno .="<td>".utf8_decode($licenca->bairro)."</td>";		 $retorno .="<td>".utf8_decode($licenca->cidade)."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>".$status."</td>";		 if($isArrayLog <> 0){			 $dataFormatadaArr = explode('-',$dadosLog[0]->data);			 $dataFormatada = $dataFormatadaArr[2].'/'.$dataFormatadaArr[1].'/'.$dataFormatadaArr[0];			 $retorno .="<td>".$dadosLog[0]->email."</td>";			 $retorno .="<td>".$dataFormatada."</td>";			 $retorno .="<td>".utf8_decode($dadosLog[0]->texto)."</td>";		 }else{			$retorno .="<td></td>";			 $retorno .="<td></td>";			 $retorno .="<td></td>";		 }		 		 $retorno .="</tr>";						 		}		$retorno .='</table>';		}	header("Content-type: application/vnd.ms-excel");	header("Content-Disposition: attachment; filename=$file");	echo $retorno;		//echo json_encode($retorno);	 }  function export_est(){			$id = $this->input->post('id_estado_export');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_model->listarLicencasByEstado($idContratante,$id);	//print_r($this->db->last_query());exit;	$file="licencas_por_estado.xls";	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno="<table border=1>		<tr>		<td>N&atilde;o H&aacute; Dados Para Esse Filtro</td>				</tr>		";		$retorno .='</table>';			}else{		$retorno="<table border=1>			<tr>			<td>Id</td>			<td>Nome Fantasia</td>			<td>CPF/CNPJ</td>			<td>Descri&ccedil;&atilde;o</td>			<td>Data Vencimento</td>			<td>Rua</td>			<td>N&uacute;mero</td>			<td>Bairro</td>			<td>Cidade</td>			<td>Estado</td>			<td>Ativo</td>			<td>Alterado Por </td>			<td>Data Altera&ccedil;&atilde;o </td>			<td>Dados Alterados </td>			</tr>			";		foreach($result as $key => $licenca){ 		$dadosLog = $this->licenca_model->listarLog($licenca->id_licenca);			$isArrayLog =  is_array($dadosLog) ? '1' : '0';				if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'/'.$dataVArr[1].'/'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->id_licenca."</td>";		 $retorno .="<td>".utf8_decode($licenca->nome_fantasia)."</td>";		 $retorno .="<td>".$licenca->cpf_cnpj."</td>";		 $retorno .="<td>".utf8_decode($licenca->descricao)."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->endereco."</td>";		 $retorno .="<td>".$licenca->numero."</td>";		 $retorno .="<td>".utf8_decode($licenca->bairro)."</td>";		 $retorno .="<td>".utf8_decode($licenca->cidade)."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>".$status."</td>";		 if($isArrayLog <> 0){			 $dataFormatadaArr = explode('-',$dadosLog[0]->data);			 $dataFormatada = $dataFormatadaArr[2].'/'.$dataFormatadaArr[1].'/'.$dataFormatadaArr[0];			 $retorno .="<td>".$dadosLog[0]->email."</td>";			 $retorno .="<td>".$dataFormatada."</td>";			 $retorno .="<td>".utf8_decode($dadosLog[0]->texto)."</td>";		 }else{			$retorno .="<td></td>";			 $retorno .="<td></td>";			 $retorno .="<td></td>";		 }		 		 $retorno .="</tr>";						 		}		$retorno .='</table>';		}	header("Content-type: application/vnd.ms-excel");	header("Content-Disposition: attachment; filename=$file");	echo $retorno;		//echo json_encode($retorno);	 }  function export_tipo(){			$id = $this->input->post('id_tipo_export');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_model->listarLicencasByTipo($idContratante,$id);	//print_r($this->db->last_query());exit;	$file="licencas_por_tipo.xls";	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno="<table border=1>		<tr>		<td>N&atilde;o H&aacute; Dados Para Esse Filtro</td>				</tr>		";		$retorno .='</table>';			}else{		$retorno="<table border=1>			<tr>			<td>Id</td>			<td>Nome Fantasia</td>			<td>CPF/CNPJ</td>			<td>Descri&ccedil;&atilde;o</td>			<td>Data Vencimento</td>			<td>Rua</td>			<td>N&uacute;mero</td>			<td>Bairro</td>			<td>Cidade</td>			<td>Estado</td>			<td>Ativo</td>			<td>Alterado Por </td>			<td>Data Altera&ccedil;&atilde;o </td>			<td>Dados Alterados </td>			</tr>			";		foreach($result as $key => $licenca){ 			$dadosLog = $this->licenca_model->listarLog($licenca->id_licenca);			$isArrayLog =  is_array($dadosLog) ? '1' : '0';				if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'/'.$dataVArr[1].'/'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->id_licenca."</td>";		 $retorno .="<td>".utf8_decode($licenca->nome_fantasia)."</td>";		 $retorno .="<td>".$licenca->cpf_cnpj."</td>";		 $retorno .="<td>".utf8_decode($licenca->descricao)."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->endereco."</td>";		 $retorno .="<td>".$licenca->numero."</td>";		 $retorno .="<td>".utf8_decode($licenca->bairro)."</td>";		 $retorno .="<td>".utf8_decode($licenca->cidade)."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>".$status."</td>";		 if($isArrayLog <> 0){			 $dataFormatadaArr = explode('-',$dadosLog[0]->data);			 $dataFormatada = $dataFormatadaArr[2].'/'.$dataFormatadaArr[1].'/'.$dataFormatadaArr[0];			 $retorno .="<td>".$dadosLog[0]->email."</td>";			 $retorno .="<td>".$dataFormatada."</td>";			 $retorno .="<td>".utf8_decode($dadosLog[0]->texto)."</td>";		 }else{			$retorno .="<td></td>";			 $retorno .="<td></td>";			 $retorno .="<td></td>";		 }		 		 $retorno .="</tr>";						 		}		$retorno .='</table>';		}	header("Content-type: application/vnd.ms-excel");	header("Content-Disposition: attachment; filename=$file");	echo $retorno;		//echo json_encode($retorno);	 } function buscaLicencaByTipo(){		$id = $this->input->get('id');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_vencer_model->listarLicencasByTipo($idContratante,$id);	$isArray =  is_array($result) ? '1' : '0';	if($isArray == 0){		$retorno .="0";			}else{			foreach($result as $key => $licenca){ 			 		if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'-'.$dataVArr[1].'-'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->razao_social."</td>";		 $retorno .="<td>".$licenca->descricao."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->bairro."</td>";		 $retorno .="<td>".$licenca->cidade."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>";		 $retorno .="<a href='$base/loja/editar_loja_licenca?id_licenca=$licenca->id_licenca&id_loja=$licenca->id_loja' class='btn btn-primary btn-xs'><i class='fa fa-pencil'></i></a>";		 $retorno .="</td>";		 $retorno .="</tr>";						 		}		}	echo json_encode($retorno);	 }function buscaLicenca(){		$id = $this->input->get('id');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;	$retorno ='';	$result = $this->licenca_vencer_model->listarLicencasByEstado($idContratante,$id);	$isArray =  is_array($result) ? '1' : '0';		if($isArray == 0){		$retorno .="<tr>";		$retorno .="<td class='hidden-phone' colspan='8'> Não Há Dados </td>";		$retorno .="</tr>";	}else{			foreach($result as $key => $licenca){ 		 		if($licenca->status == 0){			$status ='Ativo';			$cor = '#009900';		 }else{			$status ='Inativo';			$cor = '#CC0000';		 }		$dataVArr = explode("-",$licenca->data_vencimento);									 		$dataVencto = $dataVArr[2].'-'.$dataVArr[1].'-'.$dataVArr[0];		 		 $base = $this->config->base_url().'index.php';		 $retorno .="<tr style='color:$cor'>";		 $retorno .="<td>".$licenca->razao_social."</td>";		 $retorno .="<td>".$licenca->descricao."</td>";		 $retorno .="<td>".$dataVencto."</td>";		 $retorno .="<td>".$licenca->bairro."</td>";		 $retorno .="<td>".$licenca->cidade."</td>";		 $retorno .="<td>".$licenca->estado."</td>";		 $retorno .="<td>";		 $retorno .="<a href='$base/loja/editar_loja_licenca?id_licenca=$licenca->id_licenca&id_loja=$licenca->id_loja' class='btn btn-primary btn-xs'><i class='fa fa-pencil'></i></a>";		 $retorno .="</td>";		 $retorno .="</tr>";						 		}		}	echo json_encode($retorno);	 } function buscaCidade(){		$id = $this->input->get('estado');		$retorno ='';	$result = $this->licenca_vencer_model->listarCidadeByEstado($id);		if($result == 0){		$retorno .="<option value='0'>Não Há Dados</option>";	}else{			$retorno .="<option value=0>Escolha uma Cidade</option>";		foreach($result as $key => $iptu){ 			 			$retorno .="<option value='".$iptu->cidade."'>".$iptu->cidade."</option>";		 		}		}	echo json_encode($retorno);	 }  function licencas_vencidas(){	  if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }	$session_data = $this->session->userdata('logged_in');		$idContratante = $_SESSION['cliente'] ;					$data['perfil'] = $session_data['perfil'];    $data['tipos_licencas'] = $this->licenca_model->listarTipoLicenca();	$data['imoveis'] = $this->licenca_model->listarLicencasVencidas($idContratante);	$data['estados'] = $this->licenca_vencida_model->listarEstado($idContratante);	$data['cidades'] = $this->licenca_model->listarCidade($idContratante);	$data['emitentes'] = $this->licenca_model->listarEmitentesComLicenca($idContratante);		//print_r($data['estados']);exit;	$this->load->helper('Paginate_helper');            $page = ($this->uri->segment(3)) ? $this->uri->segment(3) : 0;	$session_data = $this->session->userdata('logged_in');		$result = $this->licenca_model->listarLicencasVencidas($idContratante,numRegister4PagePaginate(), $page);			////print_r($this->db->last_query());exit;	//print$session_data['licencaVencida'];exit;	$data['paginacao'] = createPaginate('licencas', $session_data['licencaVencida']  ) ;		$data['licencas'] = $result;	$data['perfil'] = $session_data['perfil'];	$this->load->view('header_view',$data);    $this->load->view('listar_licencas_vencidas_view', $data);	$this->load->view('footer_view');	 } 
 function listar(){	  if(!$this->session->userdata('logged_in')){		redirect('login', 'refresh');  }	$session_data = $this->session->userdata('logged_in');		$idContratante = $_SESSION['cliente'] ;					$data['perfil'] = $session_data['perfil'];		$data['tipos_licencas'] = $this->lojas_licencas_model->listarTipoLicenca();	//$data['imoveis'] = $this->licenca_model->listarLicencasVencer($idContratante);	$data['estados'] = $this->licenca_vencer_model->listarEstado($idContratante);	$data['cidades'] = $this->licenca_vencer_model->listarCidade($idContratante);	$data['emitentes'] = $this->licenca_vencer_model->listarEmitentesComLicenca($idContratante);	//print_r($data['estados']);exit;	$this->load->helper('Paginate_helper');            $page = ($this->uri->segment(3)) ? $this->uri->segment(3) : 0;	$session_data = $this->session->userdata('logged_in');		$result = $this->licenca_model->listarLicencasVencer($idContratante,numRegister4PagePaginate(), $page);			////print_r($this->db->last_query());exit;	$data['paginacao'] = createPaginate('licencas_vencidas', $session_data['licencaVencida']) ;		$data['licencas'] = $result;	$data['perfil'] = $session_data['perfil'];	$this->load->view('header_view',$data);    $this->load->view('listar_licencas_vencer_view', $data);	$this->load->view('footer_view');	
 }

}
 
?>