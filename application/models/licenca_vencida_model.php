<?php
Class Licenca_Vencida_model extends CI_Model{  function somarTodos(){	return $this->db->count_all('licencas');      }     function somarTodasVencidas($idContratante){	$data1 = date('Y-m-d', strtotime("+40 days"));	$data2 = date('Y-m-d', strtotime("+45 days"));     $sql = " select count(*) as total from licencas where id_contratante = ?  and data_vencimento between ? and ?";   $query = $this->db->query($sql, array($idContratante,$data1,$data2));   $array = $query->result_array(); //array of arrays   return($array);    }      function listarEstado($id_contratante){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this->db->distinct();   $this -> db -> select('estado');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> where('loja.id_contratante', $id_contratante);     $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);          $this -> db -> order_by('loja.estado');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarEmitentesComLicenca($id_contratante){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this->db->distinct();   $this -> db -> select('*,lojas_licencas.id_licenca as id_licenca');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> join('tipo_licenca_taxa','lojas_licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','loja.id_emitente = emitente.id');      $this -> db -> where('loja.id_contratante', $id_contratante);      $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);       $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarCidade($id_contratante){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this->db->distinct();   $this -> db -> select('cidade');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> where('loja.id_contratante', $id_contratante);     $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);          $this -> db -> order_by('loja.cidade');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }function listarCidadeByEstado($id){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this->db->distinct();   $this -> db -> select('cidade');   $this -> db -> from('lojas_licencas');      $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> where('loja.estado', $id);   $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);       $this -> db -> order_by('loja.cidade');   $query = $this -> db -> get();	//print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0){     return $query->result();   }else{     return 0;   } }   function listarLicencasVencidas($id_contratante,$_limit = 30, $_start = 0 ){  $data1 = date('Y-m-d');  $data2 = date('Y-m-d', strtotime("+45 days"));   $this -> db ->limit( $_limit, $_start ); 	   $this -> db -> select('*,licencas.ativo as status,licencas.id as id_licenca');   $this -> db -> from('licencas');    $this -> db -> join('tipo_licenca_taxa','licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','licencas.id_emitente = emitente.id');      $this -> db -> where('licencas.id_contratante', $id_contratante);      $this -> db -> where('licencas.data_vencimento >', $data1);      $this -> db -> where('licencas.data_vencimento <', $data2);      $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } } 
  function listarLicencas($id_contratante,$_limit = 30, $_start = 0 ){   $data1 = date('Y-m-d');  $data2 = date('Y-m-d', strtotime("+45 days"));   $this -> db ->limit( $_limit, $_start ); 	   $this -> db -> select('*,licencas.ativo as status,licencas.id as id_licenca');   $this -> db -> from('licencas');    $this -> db -> join('tipo_licenca_taxa','licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','licencas.id_emitente = emitente.id');      $this -> db -> where('licencas.id_contratante', $id_contratante);      $this -> db -> where('licencas.data_vencimento >', $data1);      $this -> db -> where('licencas.data_vencimento <', $data2);      $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   }
 }    function listarContratante($id_contratante){   $this -> db -> select('*');   $this -> db -> from('contratante');    $this -> db -> where('contratante.id', $id_contratante);      $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarLog($idOperacao){   $this -> db ->limit( 1, 0 ); 		   $this -> db -> select('log_tabelas.*,usuarios.email');   $this -> db -> from('log_tabelas');    $this -> db -> join('usuarios','log_tabelas.id_usuario = usuarios.id');      $this -> db -> where('log_tabelas.id_operacao', $idOperacao);     $this -> db -> where('log_tabelas.tabela', 'licencas');    $this -> db -> order_by('log_tabelas.id','desc');      $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarLicencasTodos($id_contratante){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("+45 days"));     $this -> db -> select('*,licencas.ativo as status,licencas.id as id_licenca');   $this -> db -> from('licencas');    $this -> db -> join('tipo_licenca_taxa','licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','licencas.id_emitente = emitente.id');      $this -> db -> where('licencas.id_contratante', $id_contratante);     $this -> db -> where('licencas.data_vencimento >', $data1);      $this -> db -> where('licencas.data_vencimento <', $data2);        $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }   function listarLicencasByEmitente($id_contratante,$emitente){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this -> db -> select('*,lojas_licencas.id_licenca as id_licenca');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> join('tipo_licenca_taxa','lojas_licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','loja.id_emitente = emitente.id');      $this -> db -> where('lojas_licencas.id_licenca', $emitente);      $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);      $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarLicencasByCidade($id_contratante,$cidade){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this -> db -> select('*,lojas_licencas.id_licenca as id_licenca');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> join('tipo_licenca_taxa','lojas_licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','loja.id_emitente = emitente.id');      $this -> db -> where('loja.id_contratante', $id_contratante);      $this -> db -> where('loja.cidade', $cidade);      $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);        $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } } function listarTipoLicencaById($tipo){   $this -> db -> select('*');   $this -> db -> from('tipo_licenca_taxa');    $this -> db -> where('tipo_licenca_taxa.id', $tipo);      $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarLicencasByTipo($id_contratante,$tipo){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));     $this -> db -> select('*,lojas_licencas.id_licenca as id_licenca');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> join('tipo_licenca_taxa','lojas_licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','loja.id_emitente = emitente.id');      $this -> db -> where('loja.id_contratante', $id_contratante);      $this -> db -> where('lojas_licencas.tipo_licenca_taxa', $tipo);      $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);     $this -> db -> order_by('emitente.razao_social');	   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } }  function listarLicencasByEstado($id_contratante,$estado){   $data1 = date('Y-m-d');   $data2 = date('Y-m-d', strtotime("-45 days"));         $this -> db -> select('*,lojas_licencas.id_licenca as id_licenca');   $this -> db -> from('lojas_licencas');    $this -> db -> join('loja','loja.id = lojas_licencas.id_loja');      $this -> db -> join('tipo_licenca_taxa','lojas_licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','loja.id_emitente = emitente.id');      $this -> db -> where('loja.id_contratante', $id_contratante);      $this -> db -> where('loja.estado', $estado);      $this -> db -> where('lojas_licencas.data_vencimento >', $data2);      $this -> db -> where('lojas_licencas.data_vencimento <', $data1);      $this -> db -> order_by('emitente.razao_social');   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0) {     return $query->result();   } else{     return false;   } } function licencasVencidas($idContratante){	//$data = date ('Y-m-d');	//$data2 = date ('Y-m-d');	$data1 = date('Y-m-d', strtotime("+40 days"));	$data2 = date('Y-m-d', strtotime("+45 days"));     $sql = " select count(*) as total from licencas where id_contratante = ?  and data_vencimento between ? and ?";   $query = $this->db->query($sql, array($idContratante,$data1,$data2));   $array = $query->result_array(); //array of arrays   return($array);    }   function listarTipoLicenca(){   $this -> db -> select('id,descricao');   $this -> db -> from('tipo_licenca_taxa');   $query = $this -> db -> get();   if($query -> num_rows() <> 0){     return $query->result();   }else{     return false;   }  }   function listarEmitentes($id_contratante){   $this -> db -> select('emitente.id,emitente.razao_social');   $this -> db -> from('emitente');   $this -> db -> join('tipo_emitente','tipo_emitente.id = emitente.tipo_emitente');   $this -> db -> where('id_contratante', $id_contratante);   $this -> db -> where('tipo_emitente', 4);   $query = $this -> db -> get();   //print_r($this->db->last_query());exit;   if($query -> num_rows() <> 0)   {     return $query->result();   }   else   {     return false;   } }  function listarLicencaById($id){  $this -> db -> select('*,licencas.ativo as status,licencas.id as id_licenca');   $this -> db -> from('licencas');    $this -> db -> join('tipo_licenca_taxa','licencas.tipo_licenca_taxa = tipo_licenca_taxa.id');      $this -> db -> join('emitente','licencas.id_emitente = emitente.id');      $this -> db -> where('licencas.id', $id);    $query = $this -> db -> get();   //print_r($this->db->last_query());exit;\\   if($query -> num_rows() <> 0)   {     return $query->result();   }   else   {     return false;   } } /* function editar(){		$id = $this->input->get('id');	$session_data = $this->session->userdata('logged_in');	$idContratante = $_SESSION['cliente'] ;		$data['emitentes'] = $this->loja_model->listarEmitentes($idContratante);	$data['estados'] = $this->loja_model->buscaEstado($idContratante);	$data['cidades'] = $this->loja_model->buscaCidades($idContratante);	$data['bandeiras'] = $this->loja_model->listarBandeira();		$data['dados_licenca'] = $this->licenca_model->listarLicencaById($id);	//print_r($this->db->last_query());exit;	//$data['emitentes'] = $result;	$data['perfil'] = $session_data['perfil'];		//$result = $this->tipo_emitente_model->listarTipoEmitente();			$this->load->view('header_view',$data);    $this->load->view('editar_licenca_view', $data);	$this->load->view('footer_view');		  } */ public function log($detalhes = array()){ 	if($this->db->insert('log_tabelas', $detalhes)) {										$id = $this->db->insert_id();				return $id;	}		return false;	}	  public function add($detalhes = array()){ 	if($this->db->insert('licencas', $detalhes)) {										$id = $this->db->insert_id();				return $id;	}		return false;	}		function atualizar($dados,$id){ 	$this->db->where('id', $id);	$this->db->update('licencas', $dados); 	//print_r($this->db->last_query());exit;	return true;   }   	      
}
?>